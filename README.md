# PNAT (Process Network Activity Tracker)
This is PNAT (Process Network Activity Tracker), a bash script that leverages auditd to __keep track of network activity__ generated by linux processes.
It comes with specifically crafted auditd rules to trace all syscalls associated with network traffic (connect, accept, sendmsg, receivemsg, ...) and process exit syscalls.

The script is intended to run as an hourly cronjob, and it will maintain a table in /var/lib/pnat/intel.sqlite, and an equivalent csv file
These files hold single network events caused by currently running processes and processes that died during the last 24 hours.

PNAT is written with the intent of enriching alerts that come from any kind of network related logs.

It does so by recording a table with the following columns:
| id | starttime  | endtime    | addr  | pid | euid | exe | 
| -- | ---------- | ---------- | ----  | --- | ---- | --- |
 * a timestamp that declares when the network activity started
 * a PID
 * an executable path
 * the EUID of the process
 * the remote IP that is involved in the activty
 * a timestamp that determines when the involved process exited

Install
```bash
 # ./install_dependencies.sh
```

Run
```bash
 # ./correlate.sh
```


### How it works
PNAT queries auditd for the following list of 'starter' system calls:
 * connect
 * accept
 * sendto
 * sendmsg
 * recvfrom
 * recvmsg
 and then for each event, it matches the first following exit or exit_group syscall made by the same PID. If it does not find any, the 'starter' record is treated as an ongoing network event, and the ending timestamp is set to 0.

The choice of monitoring from connect/accept/sendmsg/... to exit/exit_group is because,
it is better to keep a record of potentially malicious processes until 24 hours after their death
and in case they run without interruption for days or weeks, we need to be able to track their activity for at least as long as they live.

### Why monitoring exit calls?
Because by just monitoring network 'starter' calls, very little context is provided to determine a time frame during which malicious network activity happened
Ideally we should close the time frame when a network socket close happens, but there is no way in auditd to distinguish network sockets from any other socket. Recording all socket close calls and then applying some filtering would be tremendously resource intensive since processes die once but may close several sockets.
Therefore, I chose to extend the time frame from a 'starter' syscall up until the process exit call. It is my attempt to contain resource usage while making sure usable data for intelligence is generated.

### TODO:
 - some install scripts for centralized auditd collection
 - adapt pnat to process logs from different hosts (add host field) when centralized auditd is configured
